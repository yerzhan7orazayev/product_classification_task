import json
from enum import Enum

import ollama
import pandas as pd
from pydantic import BaseModel

categories = {
    "Товары": [
        "Автомобили, прицепы и полуприцепы",
        "Бумага и изделия бумажные",
        "Вещества химические и продукты химические",
        "Вода природная; услуги по обработке и распределению воды",
        "Древесина и изделия из древесины и пробки (кроме мебели); изделия из соломки и материалов для плетения",
        "Изделия готовые прочие",
        "Изделия металлические готовые, кроме машин и оборудования",
        "Изделия минеральные неметаллические прочие",
        "Изделия резиновые и пластмассовые",
        "Изделия табачные",
        "Кожа и изделия, относящиеся к ней",
        "Кокс и продукция переработки нефти",
        "Компьютеры, продукция электронная и оптическая",
        "Машины и оборудование, не включенные в другие группировки",
        "Мебель",
        "Металлы основные",
        "Напитки",
        "Нефть сырая и газ природный",
        "Оборудование транспортное прочее",
        "Оборудование электрическое",
        "Предметы одежды",
        "Продукты пищевые",
        "Продукты фармацевтические и препараты фармацевтические основные",
        "Продукция горнодобывающей промышленности",
        "Продукция лесного хозяйства, лесозаготовок и услуги в этих областях",
        "Продукция сельского хозяйства, охоты и связанные с этим услуги",
        "Руды металлические",
        "Рыба и продукция рыболовства прочая; аквакультура; услуги вспомогательные в области рыболовства",
        "Текстиль",
        "Уголь каменный и лигнит",
        "Электроэнергия, газ, пар и вода горячая"
    ],
    "Работы": [
        "Работы по возведению зданий",
        "Работы строительные по возведению объектов гражданского строительства",
        "Работы строительные специализированные"
    ],
    "Услуги": [
        "Услуги библиотек, архивов, музеев и прочих культурных учреждений",
        "Услуги в области архитектуры, инженерных изысканий, технических испытаний и анализа",
        "Услуги в области государственного управления и обороны; услуги по обязательному социальному обеспечению",
        "Услуги в области здравоохранения",
        "Услуги в области образования",
        "Услуги в области обслуживания зданий и территорий",
        "Услуги в области рекламы и изучения рынка",
        "Услуги в области творчества, искусства и развлечений",
        "Услуги ветеринарные",
        "Услуги водного транспорта",
        "Услуги воздушного транспорта",
        "Услуги вспомогательные в области горнодобывающей промышленности",
        "Услуги вспомогательные по отношению к финансовому посредничеству и страхованию",
        "Услуги головных компаний; услуги консультационные по вопросам управлений",
        "Услуги домашних хозяйств в качестве работодателей для домашней прислуги",
        "Услуги индивидуальные прочие",
        "Услуги информационные",
        "Услуги офисные административные, офисные вспомогательные и прочие",
        "Услуги по аренде",
        "Услуги по изданию",
        "Услуги по канализации; удалению и обработке сточных вод",
        "Услуги по компьютерному программированию, услуги консультационные и аналогичные",
        "Услуги по научным исследованиям и разработкам",
        "Услуги по обеззараживанию и услуги в области удаления отходов прочие",
        "Услуги по организации азартных игр и заключению пари",
        "Услуги по организации проживания",
        "Услуги по печатанию и воспроизведению",
        "Услуги по предоставлению продуктов питания и напитков",
        "Услуги по проведению расследований и обеспечению безопасности",
        "Услуги по производству кино-, видеофильмов и телевизионных программ, фонограмм и музыкальных записей",
        "Услуги по ремонту и установке машин и оборудования",
        "Услуги по ремонту компьютеров, предметов личного потребления и бытовых товаров",
        "Услуги по сбору, обработке и удалению отходов; услуги по получению вторичного сырья",
        "Услуги по созданию программ и телерадиовещанию",
        "Услуги по страхованию, перестрахованию и пенсионному обеспечению, кроме услуг по обязательному социальному обеспечению",
        "Услуги по торговле оптовой и розничной; услуги по ремонту автомобилей и мотоциклов",
        "Услуги по торговле оптовой, кроме торговли автомобилями и мотоциклами",
        "Услуги по торговле розничной, за исключением автомобилями и мотоциклами",
        "Услуги по трудоустройству",
        "Услуги по хранению и услуги транспортные вспомогательные",
        "Услуги почтовые и курьерские",
        "Услуги профессиональные, научные и технические прочие",
        "Услуги связи",
        "Услуги социальные без обеспечения проживания",
        "Услуги социальные с обеспечением проживания",
        "Услуги спортивные и услуги по организации отдыха",
        "Услуги сухопутного транспорта и транспортирование по трубопроводам",
        "Услуги туристических агентств, туроператоров и услуги по бронированию и сопутствующие им услуги",
        "Услуги финансовые, кроме услуг по страхованию и обеспечению пенсионному",
        "Услуги частных домашних хозяйств по производству разнообразных товаров для собственного потребления",
        "Услуги членских организаций",
        "Услуги экстерриториальных организаций и органов",
        "Услуги юридические и бухгалтерские"
    ]
}

# Sub-subcategories (Level 3)
subsubcategories = {
    # ТОВАРЫ
    "Автомобили, прицепы и полуприцепы": [
        "Легковые автомобили",
        "Грузовые автомобили",
        "Автобусы",
        "Прицепы и полуприцепы",
        "Запасные части и аксессуары"
    ],
    "Бумага и изделия бумажные": [
        "Бумага писчая и печатная",
        "Картон и гофрокартон",
        "Санитарно-гигиенические изделия",
        "Канцелярские товары",
        "Упаковочные материалы"
    ],
    "Вещества химические и продукты химические": [
        "Химические реагенты",
        "Полимеры и пластмассы",
        "Краски и лаки",
        "Удобрения",
        "Бытовая химия"
    ],
    "Вода природная; услуги по обработке и распределению воды": [
        "Питьевая вода",
        "Техническая вода",
        "Минеральная вода",
        "Очистка воды",
        "Водоснабжение"
    ],
    "Древесина и изделия из древесины и пробки (кроме мебели); изделия из соломки и материалов для плетения": [
        "Пиломатериалы",
        "Фанера и ДСП",
        "Деревянная тара",
        "Изделия из пробки",
        "Плетеные изделия"
    ],
    "Изделия готовые прочие": [
        "Ювелирные изделия",
        "Музыкальные инструменты",
        "Спортивные товары",
        "Игрушки",
        "Канцелярские принадлежности"
    ],
    "Изделия металлические готовые, кроме машин и оборудования": [
        "Металлоконструкции",
        "Крепежные изделия",
        "Инструменты ручные",
        "Металлическая тара",
        "Изделия из проволоки"
    ],
    "Изделия минеральные неметаллические прочие": [
        "Стекло и изделия из стекла",
        "Керамические изделия",
        "Цемент и бетон",
        "Кирпич и блоки",
        "Абразивные материалы"
    ],
    "Изделия резиновые и пластмассовые": [
        "Шины и покрышки",
        "Резиновые изделия технические",
        "Пластиковая упаковка",
        "Трубы пластиковые",
        "Изделия из пенопласта"
    ],
    "Изделия табачные": [
        "Сигареты",
        "Сигары",
        "Табак курительный",
        "Табак нюхательный",
        "Электронные сигареты"
    ],
    "Кожа и изделия, относящиеся к ней": [
        "Кожа выделанная",
        "Обувь кожаная",
        "Галантерея кожаная",
        "Перчатки кожаные",
        "Ремни и пояса"
    ],
    "Кокс и продукция переработки нефти": [
        "Бензин",
        "Дизельное топливо",
        "Мазут",
        "Битум",
        "Смазочные материалы"
    ],
    "Компьютеры, продукция электронная и оптическая": [
        "Компьютеры и ноутбуки",
        "Серверное оборудование",
        "Периферийные устройства",
        "Оптические приборы",
        "Электронные компоненты"
    ],
    "Машины и оборудование, не включенные в другие группировки": [
        "Промышленное оборудование",
        "Насосы и компрессоры",
        "Подъемно-транспортное оборудование",
        "Холодильное оборудование",
        "Оборудование для сельского хозяйства"
    ],
    "Мебель": [
        "Мебель офисная",
        "Мебель домашняя",
        "Мебель медицинская",
        "Мебель для общественных помещений",
        "Мебель специализированная"
    ],
    "Металлы основные": [
        "Черные металлы",
        "Цветные металлы",
        "Драгоценные металлы",
        "Прокат металлический",
        "Металлический лом"
    ],
    "Напитки": [
        "Безалкогольные напитки",
        "Алкогольные напитки",
        "Соки и нектары",
        "Минеральная вода",
        "Энергетические напитки"
    ],
    "Нефть сырая и газ природный": [
        "Нефть сырая",
        "Газ природный",
        "Газовый конденсат",
        "Попутный нефтяной газ",
        "Сжиженный природный газ"
    ],
    "Оборудование транспортное прочее": [
        "Железнодорожный транспорт",
        "Водный транспорт",
        "Воздушный транспорт",
        "Мотоциклы и велосипеды",
        "Транспорт специализированный"
    ],
    "Оборудование электрическое": [
        "Электродвигатели и генераторы",
        "Трансформаторы",
        "Кабели и провода",
        "Осветительное оборудование",
        "Электроустановочные изделия"
    ],
    "Предметы одежды": [
        "Верхняя одежда",
        "Нижнее белье",
        "Трикотажные изделия",
        "Спецодежда",
        "Головные уборы"
    ],
    "Продукты пищевые": [
        "Мясо и мясопродукты",
        "Молоко и молочные продукты",
        "Хлебобулочные изделия",
        "Консервы",
        "Кондитерские изделия"
    ],
    "Продукты фармацевтические и препараты фармацевтические основные": [
        "Лекарственные препараты",
        "Витамины и БАДы",
        "Вакцины и сыворотки",
        "Медицинские изделия",
        "Диагностические препараты"
    ],
    "Продукция горнодобывающей промышленности": [
        "Строительный камень",
        "Песок и гравий",
        "Глина и каолин",
        "Гипс",
        "Минералы прочие"
    ],
    "Продукция лесного хозяйства, лесозаготовок и услуги в этих областях": [
        "Древесина круглая",
        "Дрова",
        "Недревесные лесные ресурсы",
        "Лесопосадочный материал",
        "Продукция побочного пользования"
    ],
    "Продукция сельского хозяйства, охоты и связанные с этим услуги": [
        "Зерновые культуры",
        "Овощи и бахчевые",
        "Фрукты и ягоды",
        "Продукция животноводства",
        "Продукция охотничьего хозяйства"
    ],
    "Руды металлические": [
        "Руды черных металлов",
        "Руды цветных металлов",
        "Руды драгоценных металлов",
        "Руды редкоземельных металлов",
        "Концентраты рудные"
    ],
    "Рыба и продукция рыболовства прочая; аквакультура; услуги вспомогательные в области рыболовства": [
        "Рыба свежая",
        "Рыба переработанная",
        "Морепродукты",
        "Продукция аквакультуры",
        "Икра"
    ],
    "Текстиль": [
        "Ткани хлопчатобумажные",
        "Ткани шерстяные",
        "Ткани синтетические",
        "Трикотажное полотно",
        "Технические ткани"
    ],
    "Уголь каменный и лигнит": [
        "Уголь каменный энергетический",
        "Уголь коксующийся",
        "Антрацит",
        "Лигнит (бурый уголь)",
        "Угольные брикеты"
    ],
    "Электроэнергия, газ, пар и вода горячая": [
        "Электроэнергия",
        "Газ природный сетевой",
        "Пар и горячая вода",
        "Холодная вода",
        "Сжатый воздух"
    ],

    # РАБОТЫ
    "Работы по возведению зданий": [
        "Жилищное строительство",
        "Строительство офисных зданий",
        "Строительство промышленных зданий",
        "Строительство торговых комплексов",
        "Реконструкция зданий"
    ],
    "Работы строительные по возведению объектов гражданского строительства": [
        "Дорожное строительство",
        "Мостовое строительство",
        "Тоннельное строительство",
        "Гидротехническое строительство",
        "Строительство инженерных сетей"
    ],
    "Работы строительные специализированные": [
        "Электромонтажные работы",
        "Санитарно-технические работы",
        "Отделочные работы",
        "Кровельные работы",
        "Монтаж оборудования"
    ],

    # УСЛУГИ
    "Услуги библиотек, архивов, музеев и прочих культурных учреждений": [
        "Библиотечные услуги",
        "Архивные услуги",
        "Музейные услуги",
        "Выставочные услуги",
        "Реставрационные услуги"
    ],
    "Услуги в области архитектуры, инженерных изысканий, технических испытаний и анализа": [
        "Архитектурное проектирование",
        "Инженерные изыскания",
        "Технические испытания",
        "Лабораторный анализ",
        "Экспертиза проектов"
    ],
    "Услуги в области государственного управления и обороны; услуги по обязательному социальному обеспечению": [
        "Государственное управление",
        "Оборонные услуги",
        "Правоохранительные услуги",
        "Пенсионное обеспечение",
        "Социальное страхование"
    ],
    "Услуги в области здравоохранения": [
        "Амбулаторное лечение",
        "Стационарное лечение",
        "Стоматологические услуги",
        "Диагностические услуги",
        "Реабилитационные услуги"
    ],
    "Услуги в области образования": [
        "Дошкольное образование",
        "Среднее образование",
        "Высшее образование",
        "Дополнительное образование",
        "Профессиональная подготовка"
    ],
    "Услуги в области обслуживания зданий и территорий": [
        "Уборка помещений",
        "Благоустройство территорий",
        "Техническое обслуживание зданий",
        "Охрана объектов",
        "Дезинфекция и дератизация"
    ],
    "Услуги в области рекламы и изучения рынка": [
        "Рекламные услуги",
        "Маркетинговые исследования",
        "PR-услуги",
        "Медиапланирование",
        "Брендинг"
    ],
    "Услуги в области творчества, искусства и развлечений": [
        "Театральные услуги",
        "Концертная деятельность",
        "Художественное творчество",
        "Кинопроизводство",
        "Организация мероприятий"
    ],
    "Услуги ветеринарные": [
        "Лечение животных",
        "Ветеринарная диагностика",
        "Вакцинация животных",
        "Хирургия ветеринарная",
        "Ветеринарные консультации"
    ],
    "Услуги водного транспорта": [
        "Морские перевозки",
        "Речные перевозки",
        "Пассажирские перевозки водным транспортом",
        "Портовые услуги",
        "Буксировка"
    ],
    "Услуги воздушного транспорта": [
        "Пассажирские авиаперевозки",
        "Грузовые авиаперевозки",
        "Аэропортовые услуги",
        "Авиатехническое обслуживание",
        "Чартерные перевозки"
    ],
    "Услуги вспомогательные в области горнодобывающей промышленности": [
        "Геологоразведка",
        "Буровые работы",
        "Взрывные работы",
        "Обогащение руд",
        "Консультации горные"
    ],
    "Услуги вспомогательные по отношению к финансовому посредничеству и страхованию": [
        "Брокерские услуги",
        "Оценка активов",
        "Актуарные услуги",
        "Услуги по управлению фондами",
        "Финансовый консалтинг"
    ],
    "Услуги головных компаний; услуги консультационные по вопросам управлений": [
        "Стратегический консалтинг",
        "Управление холдингом",
        "Бизнес-планирование",
        "Оптимизация процессов",
        "Управленческий учет"
    ],
    "Услуги домашних хозяйств в качестве работодателей для домашней прислуги": [
        "Услуги домработниц",
        "Услуги нянь",
        "Услуги садовников",
        "Услуги водителей",
        "Услуги поваров"
    ],
    "Услуги индивидуальные прочие": [
        "Парикмахерские услуги",
        "Косметические услуги",
        "Ритуальные услуги",
        "Прачечные услуги",
        "Услуги химчистки"
    ],
    "Услуги информационные": [
        "Информационные порталы",
        "Базы данных",
        "Новостные агентства",
        "Аналитические услуги",
        "Информационная поддержка"
    ],
    "Услуги офисные административные, офисные вспомогательные и прочие": [
        "Секретарские услуги",
        "Документооборот",
        "Колл-центр",
        "Копировальные услуги",
        "Переводческие услуги"
    ],
    "Услуги по аренде": [
        "Аренда недвижимости",
        "Аренда транспорта",
        "Аренда оборудования",
        "Лизинг",
        "Прокат инструментов"
    ],
    "Услуги по изданию": [
        "Издание книг",
        "Издание журналов",
        "Издание газет",
        "Электронные издания",
        "Редакционные услуги"
    ],
    "Услуги по канализации; удалению и обработке сточных вод": [
        "Канализационные услуги",
        "Очистка сточных вод",
        "Обслуживание септиков",
        "Утилизация осадков",
        "Ливневая канализация"
    ],
    "Услуги по компьютерному программированию, услуги консультационные и аналогичные": [
        "Разработка ПО",
        "Веб-разработка",
        "Мобильная разработка",
        "IT-консалтинг",
        "Системная интеграция"
    ],
    "Услуги по научным исследованиям и разработкам": [
        "Фундаментальные исследования",
        "Прикладные исследования",
        "Опытно-конструкторские работы",
        "Научные эксперименты",
        "Научные консультации"
    ],
    "Услуги по обеззараживанию и услуги в области удаления отходов прочие": [
        "Дезинфекция",
        "Дезинсекция",
        "Дератизация",
        "Санитарная обработка",
        "Биологическая очистка"
    ],
    "Услуги по организации азартных игр и заключению пари": [
        "Казино",
        "Букмекерские услуги",
        "Лотереи",
        "Игровые автоматы",
        "Онлайн-гемблинг"
    ],
    "Услуги по организации проживания": [
        "Гостиничные услуги",
        "Хостелы",
        "Санатории",
        "Базы отдыха",
        "Кемпинги"
    ],
    "Услуги по печатанию и воспроизведению": [
        "Типографские услуги",
        "Цифровая печать",
        "Копировальные услуги",
        "Полиграфическое производство",
        "Брошюровочные работы"
    ],
    "Услуги по предоставлению продуктов питания и напитков": [
        "Ресторанные услуги",
        "Кафе и столовые",
        "Кейтеринг",
        "Доставка еды",
        "Фаст-фуд"
    ],
    "Услуги по проведению расследований и обеспечению безопасности": [
        "Охранные услуги",
        "Детективные услуги",
        "Видеонаблюдение",
        "Пожарная охрана",
        "Инкассация"
    ],
    "Услуги по производству кино-, видеофильмов и телевизионных программ, фонограмм и музыкальных записей": [
        "Кинопроизводство",
        "Видеопроизводство",
        "Звукозапись",
        "Монтаж",
        "Постпродакшн"
    ],
    "Услуги по ремонту и установке машин и оборудования": [
        "Ремонт промышленного оборудования",
        "Установка оборудования",
        "Техническое обслуживание",
        "Модернизация оборудования",
        "Пусконаладочные работы"
    ],
    "Услуги по ремонту компьютеров, предметов личного потребления и бытовых товаров": [
        "Ремонт компьютеров",
        "Ремонт телефонов",
        "Ремонт бытовой техники",
        "Ремонт обуви",
        "Ремонт одежды"
    ],
    "Услуги по сбору, обработке и удалению отходов; услуги по получению вторичного сырья": [
        "Вывоз мусора",
        "Сортировка отходов",
        "Переработка отходов",
        "Утилизация опасных отходов",
        "Рециклинг"
    ],
    "Услуги по созданию программ и телерадиовещанию": [
        "Телевещание",
        "Радиовещание",
        "Производство контента",
        "Стриминговые услуги",
        "Кабельное телевидение"
    ],
    "Услуги по страхованию, перестрахованию и пенсионному обеспечению, кроме услуг по обязательному социальному обеспечению": [
        "Имущественное страхование",
        "Личное страхование",
        "Медицинское страхование",
        "Перестрахование",
        "Негосударственное пенсионное обеспечение"
    ],
    "Услуги по торговле оптовой и розничной; услуги по ремонту автомобилей и мотоциклов": [
        "Оптовая торговля",
        "Розничная торговля",
        "Ремонт автомобилей",
        "Ремонт мотоциклов",
        "Автосервис"
    ],
    "Услуги по торговле оптовой, кроме торговли автомобилями и мотоциклами": [
        "Оптовая торговля продуктами питания",
        "Оптовая торговля промышленными товарами",
        "Оптовая торговля сырьем",
        "Оптовая торговля оборудованием",
        "Дистрибуция"
    ],
    "Услуги по торговле розничной, за исключением автомобилями и мотоциклами": [
        "Супермаркеты",
        "Специализированная розница",
        "Интернет-магазины",
        "Торговля на рынках",
        "Киоски и павильоны"
    ],
    "Услуги по трудоустройству": [
        "Рекрутинг",
        "Кадровый лизинг",
        "Аутстаффинг",
        "Биржа труда",
        "Подбор персонала"
    ],
    "Услуги по хранению и услуги транспортные вспомогательные": [
        "Складское хранение",
        "Холодильное хранение",
        "Логистические услуги",
        "Таможенные услуги",
        "Экспедирование"
    ],
    "Услуги почтовые и курьерские": [
        "Почтовая доставка",
        "Курьерская доставка",
        "Экспресс-доставка",
        "Международная доставка",
        "Доставка посылок"
    ],
    "Услуги профессиональные, научные и технические прочие": [
        "Геодезические услуги",
        "Картографические услуги",
        "Метрологические услуги",
        "Патентные услуги",
        "Технические переводы"
    ],
    "Услуги связи": [
        "Мобильная связь",
        "Стационарная связь",
        "Интернет-услуги",
        "Спутниковая связь",
        "Дата-центры"
    ],
    "Услуги социальные без обеспечения проживания": [
        "Социальная работа",
        "Помощь инвалидам",
        "Помощь пожилым",
        "Психологическая помощь",
        "Социальная адаптация"
    ],
    "Услуги социальные с обеспечением проживания": [
        "Дома престарелых",
        "Интернаты",
        "Реабилитационные центры",
        "Детские дома",
        "Приюты"
    ],
    "Услуги спортивные и услуги по организации отдыха": [
        "Фитнес-клубы",
        "Спортивные секции",
        "Парки развлечений",
        "Организация туров",
        "Проведение мероприятий"
    ],
    "Услуги сухопутного транспорта и транспортирование по трубопроводам": [
        "Автомобильные перевозки",
        "Железнодорожные перевозки",
        "Трубопроводный транспорт",
        "Пассажирские перевозки",
        "Грузовые перевозки"
    ],
    "Услуги туристических агентств, туроператоров и услуги по бронированию и сопутствующие им услуги": [
        "Туроператорские услуги",
        "Турагентские услуги",
        "Бронирование отелей",
        "Бронирование билетов",
        "Визовая поддержка"
    ],
    "Услуги финансовые, кроме услуг по страхованию и обеспечению пенсионному": [
        "Банковские услуги",
        "Кредитование",
        "Инвестиционные услуги",
        "Валютные операции",
        "Лизинговые услуги"
    ],
    "Услуги частных домашних хозяйств по производству разнообразных товаров для собственного потребления": [
        "Домашнее производство продуктов",
        "Домашнее рукоделие",
        "Домашнее садоводство",
        "Домашнее животноводство",
        "Заготовки домашние"
    ],
    "Услуги членских организаций": [
        "Профсоюзы",
        "Общественные организации",
        "Политические партии",
        "Религиозные организации",
        "Клубы по интересам"
    ],
    "Услуги экстерриториальных организаций и органов": [
        "Международные организации",
        "Дипломатические представительства",
        "Консульские услуги",
        "Посольства",
        "Миссии международные"
    ],
    "Услуги юридические и бухгалтерские": [
        "Юридические консультации",
        "Судебное представительство",
        "Бухгалтерский учет",
        "Аудиторские услуги",
        "Налоговое консультирование"
    ]
}


class Category(str, Enum):
    goods = "Товары"
    works = "Работы"
    services = "Услуги"


# Create dynamic Enums for subcategories
def create_subcategory_enum(category_name: str, subcategories: list):
    """Dynamically create an Enum for subcategories"""
    enum_dict = {
        f"sub_{i}": value
        for i, value in enumerate(subcategories)
    }
    return Enum(f'{category_name}Subcategory', enum_dict, type=str)


# Create dynamic Enums for sub-subcategories
def create_subsubcategory_enum(subcategory_name: str, subsubcategories: list):
    """Dynamically create an Enum for sub-subcategories"""
    enum_dict = {
        f"subsub_{i}": value
        for i, value in enumerate(subsubcategories)
    }
    # Clean name for Enum
    clean_name = subcategory_name.replace(" ", "_").replace(",", "").replace(";", "").replace("(", "").replace(")", "")
    return Enum(f'{clean_name}SubSubcategory', enum_dict, type=str)


# Create Enums for each category (Level 2)
GoodsSubcategory = create_subcategory_enum("Goods", categories["Товары"])
WorksSubcategory = create_subcategory_enum("Works", categories["Работы"])
ServicesSubcategory = create_subcategory_enum("Services", categories["Услуги"])


# Level 1 classification model
class Level1Classification(BaseModel):
    category: Category


# Level 2 classification models with specific Enums
class GoodsClassification(BaseModel):
    subcategory: GoodsSubcategory


class WorksClassification(BaseModel):
    subcategory: WorksSubcategory


class ServicesClassification(BaseModel):
    subcategory: ServicesSubcategory


def classify_level1(text: str) -> str:
    """First level classification: Товары/Работы/Услуги"""
    schema = Level1Classification.model_json_schema()

    system = """Ты классифицируешь наименование на верхнем уровне.
- Товары: физические вещи, которые можно купить (материалы, продукция, оборудование)
- Работы: действия по созданию, строительству, монтажу или ремонту чего-либо
- Услуги: предоставление профессиональной помощи без создания материального объекта
"""

    user_prompt = f'Наименование: "{text}"'

    r = ollama.chat(
        model="qwen2.5:0.5b-instruct",
        format=schema,
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": user_prompt}
        ]
    )

    payload = json.loads(r["message"]["content"])
    parsed = Level1Classification(**payload)
    return parsed.category.value


def classify_level2(text: str, main_category: str) -> str:
    """Second level classification: specific subcategory with appropriate Enum"""
    subcategories = categories[main_category]

    # Select the appropriate model and schema based on main category
    if main_category == "Товары":
        model_class = GoodsClassification
    elif main_category == "Работы":
        model_class = WorksClassification
    else:  # Услуги
        model_class = ServicesClassification

    schema = model_class.model_json_schema()

    subcategories_list = "\n".join([f"- {sc}" for sc in subcategories])

    system = f"""Ты классифицируешь наименование в одну из следующих подкатегорий категории "{main_category}":

{subcategories_list}

Выбери наиболее подходящую подкатегорию из списка выше. Используй точное название из списка."""

    user_prompt = f'Наименование: "{text}"\nКатегория: {main_category}'

    r = ollama.chat(
        model="qwen2.5:0.5b-instruct",
        format=schema,
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": user_prompt}
        ]
    )

    payload = json.loads(r["message"]["content"])
    parsed = model_class(**payload)

    return parsed.subcategory.value


def classify_level3(text: str, main_category: str, subcategory: str) -> str:
    """Third level classification: specific sub-subcategory with dynamic Enum"""
    subsubcats = subsubcategories.get(subcategory, [])

    if not subsubcats:
        return "Не определено"

    # Create dynamic Enum for this specific subcategory
    SubSubEnum = create_subsubcategory_enum(subcategory, subsubcats)

    # Create dynamic Pydantic model
    class Level3Classification(BaseModel):
        subsubcategory: SubSubEnum

    schema = Level3Classification.model_json_schema()

    subsubcats_list = "\n".join([f"- {ssc}" for ssc in subsubcats])

    system = f"""Ты классифицируешь наименование в одну из следующих под-подкатегорий подкатегории "{subcategory}":

{subsubcats_list}

Выбери наиболее подходящую под-подкатегорию из списка выше. Используй точное название из списка."""

    user_prompt = f'Наименование: "{text}"\nКатегория: {main_category}\nПодкатегория: {subcategory}'

    r = ollama.chat(
        model="qwen2.5:0.5b-instruct",
        format=schema,
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": user_prompt}
        ]
    )

    payload = json.loads(r["message"]["content"])
    parsed = Level3Classification(**payload)

    return parsed.subsubcategory.value


# Read CSV
df = pd.read_csv("esf_fulll_202511211949.csv", nrows=500, on_bad_lines="skip")

# Process each description
results = []
for idx, text in enumerate(df["DESCRIPTION"].astype(str), 1):
    print(f"Processing {idx}/{len(df)}...")

    # Level 1: Main category
    main_category = classify_level1(text)

    # Level 2: Subcategory
    subcategory = classify_level2(text, main_category)

    # Level 3: Sub-subcategory
    subsubcategory = classify_level3(text, main_category, subcategory)

    results.append(
        {
            "description": text,
            "main_category": main_category,
            "subcategory": subcategory,
            "subsubcategory": subsubcategory
        }
    )

    print(f"  {main_category} -> {subcategory} -> {subsubcategory}")

# Save results to CSV
results_df = pd.DataFrame(results)
results_df.to_csv("classification_results_3level.csv", index=False, encoding="utf-8-sig")

# Print summary
print("\n=== SUMMARY ===")
print(results_df.groupby(["main_category", "subcategory", "subsubcategory"]).size().to_string())
